# Lab 5: Web Apps in Azure


## Exercise 1: Create Web App

#### Task 1: Open the Azure Portal

1. In an open browser window, navigate to the **Azure Portal** (<https://portal.azure.com>).

#### Task 2: Open Cloud Shell

1. At the top of the portal, click the **Cloud Shell** icon to open a new shell instance.

#### Task 3: Create an App Service plan

1. At the **Cloud Shell** command prompt at the bottom of the portal, type in the following command and press **Enter** to create a variable which value designates the name of the resource group you will use in this exercise:

```sh
RESOURCE_GROUP_APP='advazure-serverless-RG-<your_initials>'
```

1. At the **Cloud Shell** command prompt at the bottom of the portal, type in the following command and press **Enter** to create a variable which value designates the region you will use in this exercise:
```sh
LOCATION='westus'
```

1. At the **Cloud Shell** command prompt at the bottom of the portal, type in the following command and press **Enter** to create a variable whose value designates the app plan you will use in this exercise:

```sh
APP_PLAN="advazure-serverless-$LOCATION-<your_initials>"
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create the resource group:

```sh
az group create --name $RESOURCE_GROUP_APP --location $LOCATION
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a new App Service plan:

```sh
az appservice plan create --is-linux --name "$APP_PLAN" --resource-group $RESOURCE_GROUP_APP --location $LOCATION --sku F1
```


#### Task 4: Create a Web App instance

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to view a list of possible runtimes for a Linux-based App Service web app instance: 

```sh
az webapp list-runtimes --linux --output tsv
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a new variable which value is a randomly generated string that you will use as the name of a new web app:

```sh
WEBAPPNAME1=webapp05021$RANDOM$RANDOM
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a new web app using a unique name:

```sh
az webapp create --name $WEBAPPNAME1 --plan "$APP_PLAN" --resource-group $RESOURCE_GROUP_APP --runtime "NODE|18-lts"
```

> **Note**: In case the command fails due to duplicate web app name, re-run the last two steps until the command completes successfully  

1. Wait for the deployment to complete before you proceed to the next task.

#### Task 5: View deployment results

1. In the Azure portal, click **Resource groups**.

1. On the **Resource groups** blade, click **advazure-serverless-RG**.

1. On the **advazure-serverless-RG** blade, click the entry representing the Azure web app you created earlier in this exercise.

1. On the web app blade, click the **Browse** button at the top of the blade. You might have to wait for a few minutes for the page to load for the first time.

1. Review the default page generated by Azure App Service.

1. Close the new browser tab and return to the browser tab displaying the Azure portal.

> **Review**: In this exercise, you created a Linux-based App Service Plan that contained a blank web app.   


## Exercise 2: Deploy Web App code

#### Task 1: Deploy code with a Web App Extension using an Azure Resource Manager template and GitHub

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a new variable which value is a randomly generated string that you will use as the name of a new web app:

```sh
WEBAPPNAME2=webapp05022$RANDOM$RANDOM
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a new web app using a unique name:

```sh
az webapp create --name $WEBAPPNAME2 --plan "$APP_PLAN" --resource-group $RESOURCE_GROUP_APP --runtime "NODE|22-lts"
```

> **Note**: In case the command fails due to duplicate web app name, re-run the last two steps until the command completes successfully  


1. In the **Cloud Shell** pane, click the **Manage files** icon and, in the drop-down menu, click **Upload**. 

1. In the **Open** dialog box, navigate to the **05-webapp/files** folder, select the **github.json** file, and click **Open**. The file contains the following Azure Resource Manager template:

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "webAppName": {
      "type": "string"
    },
    "repositoryUrl": {
      "type": "string"
    },
    "branch": {
      "type": "string",
      "defaultValue": "main"
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2023-01-01",
      "name": "[parameters('webAppName')]",
      "location": "[parameters('location')]",
      "properties": {},
      "resources": [
        {
          "type": "sourcecontrols",
          "apiVersion": "2022-03-01",
          "name": "web",
          "dependsOn": [
            "[resourceId('Microsoft.Web/sites', parameters('webAppName'))]"
          ],
          "properties": {
            "repoUrl": "[parameters('repositoryUrl')]",
            "branch": "[parameters('branch')]",
            "isManualIntegration": true
          }
        }
      ]
    }
  ]
}
```

1. In the **Cloud Shell** pane, click the **Manage files** icon and, in the drop-down menu, click **Upload**. 

1. In the **Open** dialog box, navigate to the **05-webapp/files** folder, select the **parameters.json** file, and click **Open**. The file contains the following parameters for the Azure Resource Manager template you uploaded previously:

```json
{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "webAppName": {
      "value": "webapp050222595427318"
    },
    "repositoryUrl": {
      "value": "https://github.com/Azure-Samples/nodejs-docs-hello-world"
    },
    "branch": {
      "value": "main"
    }
  }
}
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a variable which value designates the name of the GitHub repository hosting the web app code:

```sh
REPOSITORY_URL='https://github.com/Azure-Samples/nodejs-docs-hello-world'
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to create a variable which value designates the name of the GitHub repository hosting the web app code and which takes into account any special character the URL might include:

```sh
REPOSITORY_URL_REGEX="$(echo $REPOSITORY_URL | sed -e 's/\\/\\\\/g; s/\//\\\//g; s/&/\\\&/g')"
```

> **Note**: This is necessary because you will use the **sed** utility to insert this string into the Azure Resource Manager template parameters file. Alternatively, you could simply open the file and enter the URL string directly into the file.  

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to replace the placeholder for the value of the **webAppName** parameter with the value of the **$WEBAPPNAME2** variable in the parameters file:

```sh
sed -i.bak1 's/"$WEBAPPNAME2"/"'"$WEBAPPNAME2"'"/' ~/parameters.json
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to replace the placeholder for the value of the **repositoryUrl** parameter with the value of the **$REPOSITORY_URL** variable in the parameters file:

```sh
sed -i.bak2 's/"$REPOSITORY_URL"/"'"$REPOSITORY_URL_REGEX"'"/' ~/parameters.json
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to verify that the placeholders were successfully replaced in the parameters file:

```sh
    cat ~/parameters.json
```

1. At the **Cloud Shell** command prompt, type in the following command and press **Enter** to deploy the GitHub-resident web app code by using a local Azure Resource Manager template and a local parameters file:

```sh
az deployment group create --resource-group $RESOURCE_GROUP_APP --template-file github.json --parameters @parameters.json
```

1. Wait for the deployment to complete before you proceed to the next task.

> **Note**: The deployment should take about a minute.  

#### Task 2: View deployment results

1. In the Azure portal, click **Resource groups**.

1. On the **Resource groups** blade, click **advazure-serverless-RG-<your_initials>**.

1. On the **advazure-serverless-RG-<your_initials>** blade, click the entry representing the Azure web app you created in the previous task.

1. On the web app blade, click the **Browse** button at the top of the blade.

1. Review the sample Node.js web application deployed from GitHub.

1. Close the new browser tab and return to the browser tab displaying the Azure portal.
